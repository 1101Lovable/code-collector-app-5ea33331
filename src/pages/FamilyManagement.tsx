import { Plus, UserPlus, Copy, Check, ArrowLeft, Users, Trash2, LogOut } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { useState, useEffect } from "react";
import { supabase } from "@/integrations/supabase/client";
import { useAuth } from "@/contexts/AuthContext";
import { toast } from "sonner";
import GroupMembers from "./GroupMembers";

interface FamilyGroup {
  id: string;
  name: string;
  created_by: string;
  member_count: number;
  invite_code: string;
}

interface FamilyManagementProps {
  onBack?: () => void;
}

export default function FamilyManagement({ onBack }: FamilyManagementProps) {
  const { user } = useAuth();
  const [myGroups, setMyGroups] = useState<FamilyGroup[]>([]);
  const [createDialogOpen, setCreateDialogOpen] = useState(false);
  const [joinDialogOpen, setJoinDialogOpen] = useState(false);
  const [newGroupName, setNewGroupName] = useState("");
  const [inviteCode, setInviteCode] = useState("");
  const [copiedCode, setCopiedCode] = useState<string | null>(null);
  const [isCreating, setIsCreating] = useState(false);
  const [isJoining, setIsJoining] = useState(false);
  const [selectedGroup, setSelectedGroup] = useState<{ id: string; name: string } | null>(null);
  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);
  const [deletingGroup, setDeletingGroup] = useState<{ id: string; name: string } | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);
  const [leaveDialogOpen, setLeaveDialogOpen] = useState(false);
  const [leavingGroup, setLeavingGroup] = useState<{ id: string; name: string } | null>(null);
  const [isLeaving, setIsLeaving] = useState(false);

  useEffect(() => {
    fetchMyGroups();
  }, [user]);

  const fetchMyGroups = async () => {
    if (!user) return;

    try {
      // Get all family groups the user is a member of
      const { data: memberships, error: membershipError } = await supabase
        .from("family_members")
        .select("family_group_id")
        .eq("user_id", user.id);

      if (membershipError) throw membershipError;

      if (!memberships || memberships.length === 0) {
        setMyGroups([]);
        return;
      }

      const groupIds = memberships.map((m) => m.family_group_id);

      // Get group details
      const { data: groups, error: groupsError } = await supabase.from("family_groups").select("*").in("id", groupIds);

      if (groupsError) throw groupsError;

      // Get member count for each group
      const groupsWithCount = await Promise.all(
        (groups || []).map(async (group) => {
          const { data: members, error: countError } = await supabase
            .from("family_members")
            .select("id")
            .eq("family_group_id", group.id);

          if (countError) {
            console.error("Error counting members:", countError);
          }

          return {
            ...group,
            member_count: members?.length || 0,
          };
        }),
      );

      setMyGroups(groupsWithCount);
    } catch (error: any) {
      console.error("Error fetching groups:", error);
      toast.error("ê·¸ë£¹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
    }
  };

  const handleCreateGroup = async () => {
    if (!user || !newGroupName.trim()) {
      toast.error("ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
      return;
    }

    setIsCreating(true);
    try {
      // Create family group (invite_code will be auto-generated by trigger)
      const { data: newGroup, error: groupError } = await supabase
        .from("family_groups")
        .insert([
          {
            name: newGroupName.trim(),
            created_by: user.id,
          },
        ] as any)
        .select("*")
        .single();

      if (groupError) throw groupError;

      // Add creator as a member
      const { error: memberError } = await supabase.from("family_members").insert({
        family_group_id: newGroup.id,
        user_id: user.id,
      });

      if (memberError) throw memberError;

      toast.success("ê·¸ë£¹ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");

      setNewGroupName("");
      setCreateDialogOpen(false);
      fetchMyGroups();
    } catch (error: any) {
      console.error("Error creating group:", error);
      toast.error("ê·¸ë£¹ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
    } finally {
      setIsCreating(false);
    }
  };

  const handleJoinGroup = async () => {
    if (!user || !inviteCode.trim()) {
      toast.error("ì´ˆëŒ€ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”");
      return;
    }

    setIsJoining(true);
    try {
      const { data, error } = await supabase.rpc('join_family_by_invite', {
        p_invite_code: inviteCode.trim(),
      });

      if (error) {
        console.error('join_family_by_invite error:', error);
        const msg = (error as any).message || '';
        if (msg.includes('INVALID_INVITE_CODE')) {
          toast.error('ìœ íš¨í•˜ì§€ ì•Šì€ ì´ˆëŒ€ ì½”ë“œì…ë‹ˆë‹¤');
        } else if (msg.includes('ALREADY_MEMBER')) {
          toast.error('ì´ë¯¸ ì°¸ì—¬í•œ ê·¸ë£¹ì…ë‹ˆë‹¤');
        } else {
          toast.error('ê·¸ë£¹ ì°¸ì—¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        }
        return;
      }

      const group = Array.isArray(data) ? data[0] : data;
      if (!group) {
        toast.error('ê·¸ë£¹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
        return;
      }

      toast.success(`"${group.group_name}" ê·¸ë£¹ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤!`);
      setInviteCode('');
      setJoinDialogOpen(false);
      fetchMyGroups();
    } catch (error: any) {
      console.error('Error joining group:', error);
      toast.error('ê·¸ë£¹ ì°¸ì—¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    } finally {
      setIsJoining(false);
    }
  };

  const handleCopyCode = (code: string) => {
    navigator.clipboard.writeText(code);
    setCopiedCode(code);
    toast.success("ì´ˆëŒ€ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤");
    setTimeout(() => setCopiedCode(null), 2000);
  };

  const handleDeleteGroup = async () => {
    if (!deletingGroup) return;

    setIsDeleting(true);
    try {
      const { error } = await supabase
        .from("family_groups")
        .delete()
        .eq("id", deletingGroup.id);

      if (error) throw error;

      toast.success(`"${deletingGroup.name}" ê·¸ë£¹ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤`);
      setDeleteDialogOpen(false);
      setDeletingGroup(null);
      fetchMyGroups();
    } catch (error: any) {
      console.error("Error deleting group:", error);
      toast.error("ê·¸ë£¹ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
    } finally {
      setIsDeleting(false);
    }
  };

  const handleLeaveGroup = async () => {
    if (!leavingGroup || !user) return;

    setIsLeaving(true);
    try {
      const { error } = await supabase
        .from("family_members")
        .delete()
        .eq("family_group_id", leavingGroup.id)
        .eq("user_id", user.id);

      if (error) throw error;

      toast.success(`"${leavingGroup.name}" ê·¸ë£¹ì—ì„œ ë‚˜ì™”ìŠµë‹ˆë‹¤`);
      setLeaveDialogOpen(false);
      setLeavingGroup(null);
      fetchMyGroups();
    } catch (error: any) {
      console.error("Error leaving group:", error);
      toast.error("ê·¸ë£¹ ë‚˜ê°€ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
    } finally {
      setIsLeaving(false);
    }
  };

  if (selectedGroup) {
    return (
      <GroupMembers groupId={selectedGroup.id} groupName={selectedGroup.name} onBack={() => setSelectedGroup(null)} />
    );
  }

  return (
    <div className="flex flex-col min-h-screen pb-24 bg-gradient-to-br from-background via-background to-secondary/30 px-4">
      <section className="pt-8 max-w-2xl mx-auto w-full">
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-4">
            {onBack && (
              <Button variant="ghost" size="icon" onClick={onBack} className="flex-shrink-0">
                <ArrowLeft size={24} />
              </Button>
            )}
            <h2 className="text-senior-2xl font-bold text-secondary-foreground">ê·¸ë£¹ ê´€ë¦¬</h2>
          </div>
        </div>

        {/* Action Buttons */}
        <div className="grid grid-cols-2 gap-3 mb-8">
          <Dialog open={createDialogOpen} onOpenChange={setCreateDialogOpen}>
            <DialogTrigger asChild>
              <Button size="xl" className="w-full">
                <Plus size={24} />
                ê·¸ë£¹ ë§Œë“¤ê¸°
              </Button>
            </DialogTrigger>
            <DialogContent className="max-w-md">
              <DialogHeader>
                <DialogTitle className="text-senior-xl">ìƒˆ ê·¸ë£¹ ë§Œë“¤ê¸°</DialogTitle>
                <DialogDescription className="text-senior-base">ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</DialogDescription>
              </DialogHeader>
              <div className="space-y-4 pt-4">
                <div className="space-y-2">
                  <Label htmlFor="group-name" className="text-senior-lg">
                    ê·¸ë£¹ ì´ë¦„
                  </Label>
                  <Input
                    id="group-name"
                    placeholder="ì˜ˆ: ìš°ë¦¬ ê·¸ë£¹"
                    className="h-14 text-senior-base px-4"
                    value={newGroupName}
                    onChange={(e) => setNewGroupName(e.target.value)}
                  />
                </div>
                <Button
                  size="xl"
                  onClick={handleCreateGroup}
                  disabled={isCreating || !newGroupName.trim()}
                  className="w-full"
                >
                  {isCreating ? "ìƒì„± ì¤‘..." : "ê·¸ë£¹ ë§Œë“¤ê¸°"}
                </Button>
              </div>
            </DialogContent>
          </Dialog>

          <Dialog open={joinDialogOpen} onOpenChange={setJoinDialogOpen}>
            <DialogTrigger asChild>
              <Button size="xl" variant="outline" className="w-full">
                <UserPlus size={24} />
                ê·¸ë£¹ ì°¸ì—¬
              </Button>
            </DialogTrigger>
            <DialogContent className="max-w-md">
              <DialogHeader>
                <DialogTitle className="text-senior-xl">ê·¸ë£¹ ì°¸ì—¬í•˜ê¸°</DialogTitle>
                <DialogDescription className="text-senior-base">ì´ˆëŒ€ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</DialogDescription>
              </DialogHeader>
              <div className="space-y-4 pt-4">
                <div className="space-y-2">
                  <Label htmlFor="invite-code" className="text-senior-lg">
                    ì´ˆëŒ€ ì½”ë“œ
                  </Label>
                  <Input
                    id="invite-code"
                    placeholder="ì˜ˆ: ABC123"
                    className="h-14 text-senior-base px-4 uppercase"
                    value={inviteCode}
                    onChange={(e) => setInviteCode(e.target.value.toUpperCase())}
                    maxLength={6}
                  />
                </div>
                <Button
                  size="xl"
                  onClick={handleJoinGroup}
                  disabled={isJoining || !inviteCode.trim()}
                  className="w-full"
                >
                  {isJoining ? "ì°¸ì—¬ ì¤‘..." : "ê·¸ë£¹ ì°¸ì—¬í•˜ê¸°"}
                </Button>
              </div>
            </DialogContent>
          </Dialog>
        </div>

        {/* My Groups */}
        <div className="space-y-4">
          <h3 className="text-senior-xl font-bold text-secondary-foreground">ë‚´ ê·¸ë£¹ ({myGroups.length})</h3>

          {myGroups.length === 0 ? (
            <Card className="p-8 text-center">
              <p className="text-senior-base text-muted-foreground mb-2">ì•„ì§ ê·¸ë£¹ì´ ì—†ì–´ìš”</p>
              <p className="text-senior-sm text-muted-foreground">ìƒˆ ê·¸ë£¹ì„ ë§Œë“¤ê±°ë‚˜ ì´ˆëŒ€ ì½”ë“œë¡œ ì°¸ì—¬í•´ë³´ì„¸ìš”</p>
            </Card>
          ) : (
            <div className="space-y-3">
              {myGroups.map((group) => (
                <Card key={group.id} className="p-6">
                  <div className="flex items-start justify-between mb-4">
                    <div>
                      <h4 className="text-senior-lg font-bold mb-1">{group.name}</h4>
                      <p className="text-senior-sm text-muted-foreground">êµ¬ì„±ì› {group.member_count}ëª…</p>
                    </div>
                    <div className="flex gap-2">
                      {group.created_by === user?.id && (
                        <span className="text-senior-xs bg-accent/10 text-accent px-3 py-1 rounded-full flex items-center gap-1">
                          ğŸ‘‘ ê·¸ë£¹ì¥
                        </span>
                      )}
                    </div>
                  </div>

                  <div className="flex items-center gap-2 bg-secondary/30 rounded-lg p-3 mb-3">
                    <div className="flex-1">
                      <p className="text-senior-xs text-muted-foreground mb-1">ì´ˆëŒ€ ì½”ë“œ</p>
                      <p className="text-senior-xl font-bold font-mono">{group.invite_code}</p>
                    </div>
                    <Button
                      variant="ghost"
                      size="icon"
                      onClick={() => handleCopyCode(group.invite_code)}
                      className="flex-shrink-0"
                    >
                      {copiedCode === group.invite_code ? (
                        <Check size={20} className="text-green-600" />
                      ) : (
                        <Copy size={20} />
                      )}
                    </Button>
                  </div>

                  <div className="flex gap-2">
                    <Button
                      variant="outline"
                      size="lg"
                      onClick={() => setSelectedGroup({ id: group.id, name: group.name })}
                      className="flex-1 gap-2"
                    >
                      <Users size={20} />
                      êµ¬ì„±ì› ë³´ê¸°
                    </Button>
                    {group.created_by === user?.id ? (
                      <Button
                        variant="destructive"
                        size="lg"
                        onClick={() => {
                          setDeletingGroup({ id: group.id, name: group.name });
                          setDeleteDialogOpen(true);
                        }}
                        className="gap-2"
                      >
                        <Trash2 size={20} />
                        ì‚­ì œ
                      </Button>
                    ) : (
                      <Button
                        variant="outline"
                        size="lg"
                        onClick={() => {
                          setLeavingGroup({ id: group.id, name: group.name });
                          setLeaveDialogOpen(true);
                        }}
                        className="gap-2"
                      >
                        <LogOut size={20} />
                        ë‚˜ê°€ê¸°
                      </Button>
                    )}
                  </div>
                </Card>
              ))}
            </div>
          )}
        </div>
      </section>

      <AlertDialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle className="text-senior-xl">ê·¸ë£¹ ì‚­ì œ</AlertDialogTitle>
            <AlertDialogDescription className="text-senior-base">
              "{deletingGroup?.name}" ê·¸ë£¹ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel className="text-senior-base">ì·¨ì†Œ</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleDeleteGroup}
              disabled={isDeleting}
              className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
            >
              {isDeleting ? "ì‚­ì œ ì¤‘..." : "ì‚­ì œ"}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>

      <AlertDialog open={leaveDialogOpen} onOpenChange={setLeaveDialogOpen}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle className="text-senior-xl">ê·¸ë£¹ ë‚˜ê°€ê¸°</AlertDialogTitle>
            <AlertDialogDescription className="text-senior-base">
              "{leavingGroup?.name}" ê·¸ë£¹ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ? ë‹¤ì‹œ ì°¸ì—¬í•˜ë ¤ë©´ ì´ˆëŒ€ ì½”ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel className="text-senior-base">ì·¨ì†Œ</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleLeaveGroup}
              disabled={isLeaving}
              className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
            >
              {isLeaving ? "ë‚˜ê°€ëŠ” ì¤‘..." : "ë‚˜ê°€ê¸°"}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}
