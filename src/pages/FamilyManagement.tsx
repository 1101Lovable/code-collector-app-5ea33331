import { Plus, UserPlus, Copy, Check, ArrowLeft, Users } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { useState, useEffect } from "react";
import { supabase } from "@/integrations/supabase/client";
import { useAuth } from "@/contexts/AuthContext";
import { toast } from "sonner";
import GroupMembers from "./GroupMembers";

interface FamilyGroup {
  id: string;
  name: string;
  created_by: string;
  member_count: number;
  is_head: boolean;
}

interface FamilyManagementProps {
  onBack?: () => void;
}

export default function FamilyManagement({ onBack }: FamilyManagementProps) {
  const { user } = useAuth();
  const [myGroups, setMyGroups] = useState<FamilyGroup[]>([]);
  const [createDialogOpen, setCreateDialogOpen] = useState(false);
  const [joinDialogOpen, setJoinDialogOpen] = useState(false);
  const [newGroupName, setNewGroupName] = useState("");
  const [inviteCode, setInviteCode] = useState("");
  const [copiedCode, setCopiedCode] = useState<string | null>(null);
  const [isCreating, setIsCreating] = useState(false);
  const [isJoining, setIsJoining] = useState(false);
  const [selectedGroup, setSelectedGroup] = useState<{ id: string; name: string } | null>(null);

  useEffect(() => {
    fetchMyGroups();
  }, [user]);

  const fetchMyGroups = async () => {
    if (!user) return;

    try {
      // Get all family groups the user is a member of
      const { data: memberships, error: membershipError } = await supabase
        .from("family_members")
        .select("family_group_id, is_head")
        .eq("user_id", user.id);

      if (membershipError) throw membershipError;

      if (!memberships || memberships.length === 0) {
        setMyGroups([]);
        return;
      }

      const groupIds = memberships.map((m) => m.family_group_id);

      // Get group details
      const { data: groups, error: groupsError } = await supabase.from("family_groups").select("*").in("id", groupIds);

      if (groupsError) throw groupsError;

      // Get member count for each group
      const groupsWithCount = await Promise.all(
        (groups || []).map(async (group) => {
          const { count } = await supabase
            .from("family_members")
            .select("*", { count: "exact", head: true })
            .eq("family_group_id", group.id);

          const membership = memberships.find((m) => m.family_group_id === group.id);

          return {
            ...group,
            member_count: count || 0,
            is_head: membership?.is_head || false,
          };
        }),
      );

      setMyGroups(groupsWithCount);
    } catch (error: any) {
      console.error("Error fetching groups:", error);
      toast.error("ê·¸ë£¹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
    }
  };

  const handleCreateGroup = async () => {
    if (!user || !newGroupName.trim()) {
      toast.error("ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
      return;
    }

    setIsCreating(true);
    try {
      // Create family group (invite_code will be auto-generated by trigger)
      const { data: newGroup, error: groupError } = await supabase
        .from("family_groups")
        .insert([
          {
            name: newGroupName.trim(),
            created_by: user.id,
          },
        ] as any)
        .select("*")
        .single();

      if (groupError) throw groupError;

      // Add creator as a member and set as head
      const { error: memberError } = await supabase.from("family_members").insert({
        family_group_id: newGroup.id,
        user_id: user.id,
        is_head: true,
      });

      if (memberError) throw memberError;

      toast.success("ê·¸ë£¹ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!");

      setNewGroupName("");
      setCreateDialogOpen(false);
      fetchMyGroups();
    } catch (error: any) {
      console.error("Error creating group:", error);
      toast.error("ê·¸ë£¹ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
    } finally {
      setIsCreating(false);
    }
  };

  const handleJoinGroup = async () => {
    if (!user || !inviteCode.trim()) {
      toast.error("ì´ˆëŒ€ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”");
      return;
    }

    setIsJoining(true);
    try {
      // Find group by name (temporary until invite_code is added)
      const { data: group, error: groupError } = await supabase
        .from("family_groups")
        .select("*")
        .eq("name", inviteCode.trim())
        .maybeSingle();

      if (groupError) {
        console.error("Error finding group:", groupError);
        toast.error("ê·¸ë£¹ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤");
        return;
      }

      if (!group) {
        toast.error("ìœ íš¨í•˜ì§€ ì•Šì€ ì´ˆëŒ€ ì½”ë“œì…ë‹ˆë‹¤");
        return;
      }

      // Check if already a member
      const { data: existingMember } = await supabase
        .from("family_members")
        .select("*")
        .eq("family_group_id", group.id)
        .eq("user_id", user.id)
        .single();

      if (existingMember) {
        toast.error("ì´ë¯¸ ì°¸ì—¬í•œ ê·¸ë£¹ì…ë‹ˆë‹¤");
        return;
      }

      // Add as member
      const { error: memberError } = await supabase.from("family_members").insert({
        family_group_id: group.id,
        user_id: user.id,
      });

      if (memberError) throw memberError;

      toast.success(`"${group.name}" ê·¸ë£¹ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤!`);
      setInviteCode("");
      setJoinDialogOpen(false);
      fetchMyGroups();
    } catch (error: any) {
      console.error("Error joining group:", error);
      toast.error("ê·¸ë£¹ ì°¸ì—¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
    } finally {
      setIsJoining(false);
    }
  };

  const handleCopyCode = (code: string) => {
    navigator.clipboard.writeText(code);
    setCopiedCode(code);
    toast.success("ì´ˆëŒ€ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤");
    setTimeout(() => setCopiedCode(null), 2000);
  };

  if (selectedGroup) {
    return (
      <GroupMembers groupId={selectedGroup.id} groupName={selectedGroup.name} onBack={() => setSelectedGroup(null)} />
    );
  }

  return (
    <div className="flex flex-col min-h-screen pb-24 bg-gradient-to-br from-background via-background to-secondary/30 px-4">
      <section className="pt-8 max-w-2xl mx-auto w-full">
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-4">
            {onBack && (
              <Button variant="ghost" size="icon" onClick={onBack} className="flex-shrink-0">
                <ArrowLeft size={24} />
              </Button>
            )}
            <h2 className="text-senior-2xl font-bold text-secondary-foreground">ê·¸ë£¹ ê´€ë¦¬</h2>
          </div>
        </div>

        {/* Action Buttons */}
        <div className="grid grid-cols-2 gap-3 mb-8">
          <Dialog open={createDialogOpen} onOpenChange={setCreateDialogOpen}>
            <DialogTrigger asChild>
              <Button size="xl" className="w-full">
                <Plus size={24} />
                ê°€ì¡± ë§Œë“¤ê¸°
              </Button>
            </DialogTrigger>
            <DialogContent className="max-w-md">
              <DialogHeader>
                <DialogTitle className="text-senior-xl">ìƒˆ ê·¸ë£¹ ë§Œë“¤ê¸°</DialogTitle>
                <DialogDescription className="text-senior-base">ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</DialogDescription>
              </DialogHeader>
              <div className="space-y-4 pt-4">
                <div className="space-y-2">
                  <Label htmlFor="group-name" className="text-senior-lg">
                    ê·¸ë£¹ ì´ë¦„
                  </Label>
                  <Input
                    id="group-name"
                    placeholder="ì˜ˆ: ìš°ë¦¬ ê°€ì¡±"
                    className="h-14 text-senior-base px-4"
                    value={newGroupName}
                    onChange={(e) => setNewGroupName(e.target.value)}
                  />
                </div>
                <Button
                  size="xl"
                  onClick={handleCreateGroup}
                  disabled={isCreating || !newGroupName.trim()}
                  className="w-full"
                >
                  {isCreating ? "ìƒì„± ì¤‘..." : "ê·¸ë£¹ ë§Œë“¤ê¸°"}
                </Button>
              </div>
            </DialogContent>
          </Dialog>

          <Dialog open={joinDialogOpen} onOpenChange={setJoinDialogOpen}>
            <DialogTrigger asChild>
              <Button size="xl" variant="outline" className="w-full">
                <UserPlus size={24} />
                ê°€ì¡± ì°¸ì—¬
              </Button>
            </DialogTrigger>
            <DialogContent className="max-w-md">
              <DialogHeader>
                <DialogTitle className="text-senior-xl">ê·¸ë£¹ ì°¸ì—¬í•˜ê¸°</DialogTitle>
                <DialogDescription className="text-senior-base">ì´ˆëŒ€ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</DialogDescription>
              </DialogHeader>
              <div className="space-y-4 pt-4">
                <div className="space-y-2">
                  <Label htmlFor="invite-code" className="text-senior-lg">
                    ì´ˆëŒ€ ì½”ë“œ
                  </Label>
                  <Input
                    id="invite-code"
                    placeholder="ì˜ˆ: ABC123"
                    className="h-14 text-senior-base px-4 uppercase"
                    value={inviteCode}
                    onChange={(e) => setInviteCode(e.target.value.toUpperCase())}
                    maxLength={6}
                  />
                </div>
                <Button
                  size="xl"
                  onClick={handleJoinGroup}
                  disabled={isJoining || !inviteCode.trim()}
                  className="w-full"
                >
                  {isJoining ? "ì°¸ì—¬ ì¤‘..." : "ê·¸ë£¹ ì°¸ì—¬í•˜ê¸°"}
                </Button>
              </div>
            </DialogContent>
          </Dialog>
        </div>

        {/* My Groups */}
        <div className="space-y-4">
          <h3 className="text-senior-xl font-bold text-secondary-foreground">ë‚´ ê·¸ë£¹ ({myGroups.length})</h3>

          {myGroups.length === 0 ? (
            <Card className="p-8 text-center">
              <p className="text-senior-base text-muted-foreground mb-2">ì•„ì§ ê·¸ë£¹ì´ ì—†ì–´ìš”</p>
              <p className="text-senior-sm text-muted-foreground">ìƒˆ ê·¸ë£¹ì„ ë§Œë“¤ê±°ë‚˜ ì´ˆëŒ€ ì½”ë“œë¡œ ì°¸ì—¬í•´ë³´ì„¸ìš”</p>
            </Card>
          ) : (
            <div className="space-y-3">
              {myGroups.map((group) => (
                <Card key={group.id} className="p-6">
                  <div className="flex items-start justify-between mb-4">
                    <div>
                      <h4 className="text-senior-lg font-bold mb-1">{group.name}</h4>
                      <p className="text-senior-sm text-muted-foreground">êµ¬ì„±ì› {group.member_count}ëª…</p>
                    </div>
                    <div className="flex gap-2">
                      {group.is_head && (
                        <span className="text-senior-xs bg-accent/10 text-accent px-3 py-1 rounded-full flex items-center gap-1">
                          ğŸ‘‘ ê°€ì¥
                        </span>
                      )}
                      {group.created_by === user?.id && (
                        <span className="text-senior-xs bg-primary/10 text-primary px-3 py-1 rounded-full">
                          ë‚´ê°€ ë§Œë“¦
                        </span>
                      )}
                    </div>
                  </div>

                  <div className="flex items-center gap-2 bg-secondary/30 rounded-lg p-3 mb-3">
                    <div className="flex-1">
                      <p className="text-senior-xs text-muted-foreground mb-1">ê·¸ë£¹ ë©¤ë²„</p>
                      <p className="text-senior-xl font-bold">{group.member_count}ëª…</p>
                    </div>
                  </div>

                  <Button
                    variant="outline"
                    size="lg"
                    onClick={() => setSelectedGroup({ id: group.id, name: group.name })}
                    className="w-full gap-2"
                  >
                    <Users size={20} />
                    êµ¬ì„±ì› ë³´ê¸°
                  </Button>
                </Card>
              ))}
            </div>
          )}
        </div>
      </section>
    </div>
  );
}
