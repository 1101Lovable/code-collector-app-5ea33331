import { Plus, UserPlus, Copy, Check, ArrowLeft, Users } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import { useState, useEffect } from "react";
import { supabase } from "@/integrations/supabase/client";
import { useAuth } from "@/contexts/AuthContext";
import { toast } from "sonner";
import GroupMembers from "./GroupMembers";

interface FamilyGroup {
  id: string;
  name: string;
  invite_code: string;
  created_by: string;
  member_count: number;
  is_head: boolean;
}

interface FamilyManagementProps {
  onBack?: () => void;
}

export default function FamilyManagement({ onBack }: FamilyManagementProps) {
  const { user } = useAuth();
  const [myGroups, setMyGroups] = useState<FamilyGroup[]>([]);
  const [createDialogOpen, setCreateDialogOpen] = useState(false);
  const [joinDialogOpen, setJoinDialogOpen] = useState(false);
  const [newGroupName, setNewGroupName] = useState("");
  const [inviteCode, setInviteCode] = useState("");
  const [copiedCode, setCopiedCode] = useState<string | null>(null);
  const [isCreating, setIsCreating] = useState(false);
  const [isJoining, setIsJoining] = useState(false);
  const [selectedGroup, setSelectedGroup] = useState<{ id: string; name: string } | null>(null);

  useEffect(() => {
    fetchMyGroups();
  }, [user]);

  const fetchMyGroups = async () => {
    if (!user) return;

    try {
      // Get user's profile with group code
      const { data: profile, error: profileError } = await supabase
        .from("profiles")
        .select("family_group_code, is_family_head")
        .eq("user_id", user.id)
        .single();

      if (profileError) throw profileError;

      if (!profile?.family_group_code) {
        setMyGroups([]);
        return;
      }

      // Get group details
      const { data: group, error: groupError } = await supabase
        .from("family_groups")
        .select("*")
        .eq("invite_code", profile.family_group_code)
        .single();

      if (groupError) throw groupError;

      // Get member count
      const { count } = await supabase
        .from("profiles")
        .select("*", { count: "exact", head: true })
        .eq("family_group_code", profile.family_group_code);

      setMyGroups([{
        ...group,
        member_count: count || 0,
        is_head: profile.is_family_head,
      }]);
    } catch (error: any) {
      console.error("Error fetching groups:", error);
      toast.error("ê·¸ë£¹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
    }
  };

  const handleCreateGroup = async () => {
    if (!user || !newGroupName.trim()) {
      toast.error("ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
      return;
    }

    setIsCreating(true);
    try {
      // Create family group (invite_code will be auto-generated by trigger)
      const { data: newGroup, error: groupError } = await supabase
        .from("family_groups")
        .insert([{
          name: newGroupName.trim(),
          created_by: user.id,
        }] as any)
        .select("*")
        .single();

      if (groupError) throw groupError;

      // Update user profile with group code and set as head
      const { error: profileError } = await supabase
        .from("profiles")
        .update({
          family_group_code: newGroup.invite_code,
          is_family_head: true,
        })
        .eq("user_id", user.id);

      if (profileError) throw profileError;

      toast.success("ê°€ì¡± ê·¸ë£¹ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!", {
        description: `ì´ˆëŒ€ ì½”ë“œ: ${newGroup.invite_code}`,
      });

      setNewGroupName("");
      setCreateDialogOpen(false);
      fetchMyGroups();
    } catch (error: any) {
      console.error("Error creating group:", error);
      toast.error("ê·¸ë£¹ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
    } finally {
      setIsCreating(false);
    }
  };

  const handleJoinGroup = async () => {
    if (!user || !inviteCode.trim()) {
      toast.error("ì´ˆëŒ€ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”");
      return;
    }

    setIsJoining(true);
    try {
      // Find group by invite code
      const { data: group, error: groupError } = await supabase
        .from("family_groups")
        .select("*")
        .eq("invite_code", inviteCode.trim().toUpperCase())
        .maybeSingle();

      if (groupError) {
        console.error("Error finding group:", groupError);
        toast.error("ê·¸ë£¹ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤");
        return;
      }

      if (!group) {
        toast.error("ìœ íš¨í•˜ì§€ ì•Šì€ ì´ˆëŒ€ ì½”ë“œì…ë‹ˆë‹¤");
        return;
      }

      // Check if already a member
      const { data: profile } = await supabase
        .from("profiles")
        .select("family_group_code")
        .eq("user_id", user.id)
        .single();

      if (profile?.family_group_code === group.invite_code) {
        toast.error("ì´ë¯¸ ì°¸ì—¬í•œ ê·¸ë£¹ì…ë‹ˆë‹¤");
        return;
      }

      // Update profile with group code
      const { error: profileError } = await supabase
        .from("profiles")
        .update({ family_group_code: group.invite_code })
        .eq("user_id", user.id);

      if (profileError) throw profileError;

      toast.success(`"${group.name}" ê·¸ë£¹ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤!`);
      setInviteCode("");
      setJoinDialogOpen(false);
      fetchMyGroups();
    } catch (error: any) {
      console.error("Error joining group:", error);
      toast.error("ê·¸ë£¹ ì°¸ì—¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
    } finally {
      setIsJoining(false);
    }
  };

  const handleCopyCode = (code: string) => {
    navigator.clipboard.writeText(code);
    setCopiedCode(code);
    toast.success("ì´ˆëŒ€ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤");
    setTimeout(() => setCopiedCode(null), 2000);
  };

  if (selectedGroup) {
    return (
      <GroupMembers
        groupId={selectedGroup.id}
        groupName={selectedGroup.name}
        onBack={() => setSelectedGroup(null)}
      />
    );
  }

  return (
    <div className="flex flex-col min-h-screen pb-24 bg-gradient-to-br from-background via-background to-secondary/30 px-4">
      <section className="pt-8 max-w-2xl mx-auto w-full">
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-4">
            {onBack && (
              <Button
                variant="ghost"
                size="icon"
                onClick={onBack}
                className="flex-shrink-0"
              >
                <ArrowLeft size={24} />
              </Button>
            )}
            <h2 className="text-senior-2xl font-bold text-secondary-foreground">
              ê°€ì¡± ê·¸ë£¹ ê´€ë¦¬
            </h2>
          </div>
        </div>

        {/* Action Buttons */}
        <div className="grid grid-cols-2 gap-3 mb-8">
          <Dialog open={createDialogOpen} onOpenChange={setCreateDialogOpen}>
            <DialogTrigger asChild>
              <Button
                size="xl"
                className="w-full"
              >
                <Plus size={24} />
                ê°€ì¡± ë§Œë“¤ê¸°
              </Button>
            </DialogTrigger>
            <DialogContent className="max-w-md">
              <DialogHeader>
                <DialogTitle className="text-senior-xl">ìƒˆ ê°€ì¡± ê·¸ë£¹ ë§Œë“¤ê¸°</DialogTitle>
                <DialogDescription className="text-senior-base">
                  ê°€ì¡± ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”
                </DialogDescription>
              </DialogHeader>
              <div className="space-y-4 pt-4">
                <div className="space-y-2">
                  <Label htmlFor="group-name" className="text-senior-lg">
                    ê·¸ë£¹ ì´ë¦„
                  </Label>
                  <Input
                    id="group-name"
                    placeholder="ì˜ˆ: ìš°ë¦¬ ê°€ì¡±"
                    className="h-14 text-senior-base px-4"
                    value={newGroupName}
                    onChange={(e) => setNewGroupName(e.target.value)}
                  />
                </div>
                <Button
                  size="xl"
                  onClick={handleCreateGroup}
                  disabled={isCreating || !newGroupName.trim()}
                  className="w-full"
                >
                  {isCreating ? "ìƒì„± ì¤‘..." : "ê·¸ë£¹ ë§Œë“¤ê¸°"}
                </Button>
              </div>
            </DialogContent>
          </Dialog>

          <Dialog open={joinDialogOpen} onOpenChange={setJoinDialogOpen}>
            <DialogTrigger asChild>
              <Button
                size="xl"
                variant="outline"
                className="w-full"
              >
                <UserPlus size={24} />
                ê°€ì¡± ì°¸ì—¬
              </Button>
            </DialogTrigger>
            <DialogContent className="max-w-md">
              <DialogHeader>
                <DialogTitle className="text-senior-xl">ê°€ì¡± ê·¸ë£¹ ì°¸ì—¬í•˜ê¸°</DialogTitle>
                <DialogDescription className="text-senior-base">
                  ì´ˆëŒ€ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”
                </DialogDescription>
              </DialogHeader>
              <div className="space-y-4 pt-4">
                <div className="space-y-2">
                  <Label htmlFor="invite-code" className="text-senior-lg">
                    ì´ˆëŒ€ ì½”ë“œ
                  </Label>
                  <Input
                    id="invite-code"
                    placeholder="ì˜ˆ: ABC123"
                    className="h-14 text-senior-base px-4 uppercase"
                    value={inviteCode}
                    onChange={(e) => setInviteCode(e.target.value.toUpperCase())}
                    maxLength={6}
                  />
                </div>
                <Button
                  size="xl"
                  onClick={handleJoinGroup}
                  disabled={isJoining || !inviteCode.trim()}
                  className="w-full"
                >
                  {isJoining ? "ì°¸ì—¬ ì¤‘..." : "ê·¸ë£¹ ì°¸ì—¬í•˜ê¸°"}
                </Button>
              </div>
            </DialogContent>
          </Dialog>
        </div>

        {/* My Groups */}
        <div className="space-y-4">
          <h3 className="text-senior-xl font-bold text-secondary-foreground">
            ë‚´ ê°€ì¡± ê·¸ë£¹ ({myGroups.length})
          </h3>

          {myGroups.length === 0 ? (
            <Card className="p-8 text-center">
              <p className="text-senior-base text-muted-foreground mb-2">
                ì•„ì§ ê°€ì¡± ê·¸ë£¹ì´ ì—†ì–´ìš”
              </p>
              <p className="text-senior-sm text-muted-foreground">
                ìƒˆ ê·¸ë£¹ì„ ë§Œë“¤ê±°ë‚˜ ì´ˆëŒ€ ì½”ë“œë¡œ ì°¸ì—¬í•´ë³´ì„¸ìš”
              </p>
            </Card>
          ) : (
            <div className="space-y-3">
              {myGroups.map((group) => (
                <Card key={group.id} className="p-6">
                  <div className="flex items-start justify-between mb-4">
                    <div>
                      <h4 className="text-senior-lg font-bold mb-1">
                        {group.name}
                      </h4>
                      <p className="text-senior-sm text-muted-foreground">
                        êµ¬ì„±ì› {group.member_count}ëª…
                      </p>
                    </div>
                    <div className="flex gap-2">
                      {group.is_head && (
                        <span className="text-senior-xs bg-accent/10 text-accent px-3 py-1 rounded-full flex items-center gap-1">
                          ğŸ‘‘ ê°€ì¥
                        </span>
                      )}
                      {group.created_by === user?.id && (
                        <span className="text-senior-xs bg-primary/10 text-primary px-3 py-1 rounded-full">
                          ë‚´ê°€ ë§Œë“¦
                        </span>
                      )}
                    </div>
                  </div>

                  <div className="flex items-center gap-2 bg-secondary/30 rounded-lg p-3 mb-3">
                    <div className="flex-1">
                      <p className="text-senior-xs text-muted-foreground mb-1">
                        ì´ˆëŒ€ ì½”ë“œ
                      </p>
                      <p className="text-senior-xl font-bold font-mono">
                        {group.invite_code}
                      </p>
                    </div>
                    <Button
                      variant="outline"
                      size="icon"
                      onClick={() => handleCopyCode(group.invite_code)}
                      className="flex-shrink-0"
                    >
                      {copiedCode === group.invite_code ? (
                        <Check size={20} className="text-primary" />
                      ) : (
                        <Copy size={20} />
                      )}
                    </Button>
                  </div>

                  <Button
                    variant="outline"
                    size="lg"
                    onClick={() => setSelectedGroup({ id: group.id, name: group.name })}
                    className="w-full gap-2"
                  >
                    <Users size={20} />
                    êµ¬ì„±ì› ë³´ê¸°
                  </Button>
                </Card>
              ))}
            </div>
          )}
        </div>
      </section>
    </div>
  );
}
